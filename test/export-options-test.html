<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
  <title>export-options test</title>
  <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import" href="../export-options.html">
</head>
<body>
  <test-fixture id="Basic">
    <template>
      <export-options></export-options>
    </template>
  </test-fixture>

  <test-fixture id="Valid">
    <template>
      <export-options file="test-file" provider="file"></export-options>
    </template>
  </test-fixture>

  <test-fixture id="FullData">
    <template>
      <export-options file="test-file.json" provider="drive" skip-import provider-options='{"parents":["test"]}'></export-options>
    </template>
  </test-fixture>

  <script>
  suite('_computeIsDrive()', () => {
    let element;
    setup(() => {
      element = fixture('Basic');
    });

    test('Returns true when drive', () => {
      const result = element._computeIsDrive('drive');
      assert.isTrue(result);
    });

    test('Returns false when file', () => {
      const result = element._computeIsDrive('file');
      assert.isFalse(result);
    });

    test('Returns false when undefined', () => {
      const result = element._computeIsDrive();
      assert.isFalse(result);
    });

    test('isDrive is false by default', () => {
      assert.isFalse(element.isDrive);
    });
  });

  suite('_isDriveChanged()', () => {
    let element;
    setup(() => {
      element = fixture('Basic');
    });

    test('Dispatches iron-resize event', () => {
      const spy = sinon.spy();
      element.addEventListener('iron-resize', spy);
      element._isDriveChanged();
      assert.isTrue(spy.called);
    });

    test('Calls _listDriveFolders() when argumet is true', () => {
      const spy = sinon.spy(element, '_listDriveFolders');
      element._isDriveChanged(true);
      assert.isTrue(spy.called);
    });

    test('Won\'t call _listDriveFolders() when argumet is false', () => {
      const spy = sinon.spy(element, '_listDriveFolders');
      element._isDriveChanged(false);
      assert.isFalse(spy.called);
    });
  });

  suite('cancel()', () => {
    let element;
    setup(() => {
      element = fixture('Basic');
    });

    test('Dispatches cancel event', () => {
      const spy = sinon.spy();
      element.addEventListener('cancel', spy);
      element.cancel();
      assert.isTrue(spy.called);
    });
  });

  suite('confirm()', () => {
    let element;
    setup((done) => {
      element = fixture('Valid');
      flush(() => done());
    });

    test('Dispatches accept event', () => {
      const spy = sinon.spy();
      element.addEventListener('accept', spy);
      element.confirm();
      assert.isTrue(spy.called);
    });

    test('Ignores event when not valid', () => {
      element.file = '';
      const spy = sinon.spy();
      element.addEventListener('accept', spy);
      element.confirm();
      assert.isFalse(spy.called);
    });

    test('Calls _getValues()', () => {
      const spy = sinon.spy(element, '_getValues');
      element.confirm();
      assert.isTrue(spy.called);
    });

    test('Event has detail', () => {
      const spy = sinon.spy();
      element.addEventListener('accept', spy);
      element.confirm();
      assert.typeOf(spy.args[0][0].detail, 'object');
      assert.deepEqual(spy.args[0][0].detail, element._getValues());
    });
  });

  suite('_getValues()', () => {
    let element;
    setup((done) => {
      element = fixture('FullData');
      flush(() => done());
    });

    test('Returns object', () => {
      const result = element._getValues();
      assert.typeOf(result, 'object');
    });

    test('Has options', () => {
      const result = element._getValues();
      assert.typeOf(result.options, 'object');
    });

    test('Options has file', () => {
      const result = element._getValues();
      assert.equal(result.options.file, 'test-file.json');
    });

    test('Options has provider', () => {
      const result = element._getValues();
      assert.equal(result.options.provider, 'drive');
    });

    test('Options has skipImport', () => {
      const result = element._getValues();
      assert.isTrue(result.options.skipImport);
    });

    test('Has providerOptions', () => {
      const result = element._getValues();
      assert.typeOf(result.providerOptions, 'object');
    });

    test('Drive has parents', () => {
      const result = element._getValues();
      const opts = result.providerOptions;
      assert.typeOf(opts.parents, 'array');
      assert.lengthOf(opts.parents, 1);
      assert.equal(opts.parents[0].name, 'test');
      assert.isUndefined(opts.parents[0].id);
    });

    test('providerOptions is not set when not Drive export', () => {
      element.provider = 'file';
      const result = element._getValues();
      assert.isUndefined(result.providerOptions);
    });
  });

  suite('_dispatchReadDriveSettings()', () => {
    let element;
    setup(() => {
      element = fixture('Basic');
    });

    test('Dispatches google-drive-list-app-folders event', () => {
      const spy = sinon.spy();
      element.addEventListener('google-drive-list-app-folders', spy);
      element._dispatchReadDriveSettings();
      assert.isTrue(spy.called);
    });

    test('Returns the event', () => {
      const e = element._dispatchReadDriveSettings();
      assert.typeOf(e, 'customevent');
      assert.equal(e.type, 'google-drive-list-app-folders');
    });

    test('Event bubbles', () => {
      const e = element._dispatchReadDriveSettings();
      assert.isTrue(e.bubbles);
    });

    test('Event is cancelable', () => {
      const e = element._dispatchReadDriveSettings();
      assert.isTrue(e.cancelable);
    });

    test('Event has detail', () => {
      const e = element._dispatchReadDriveSettings();
      assert.typeOf(e.detail, 'object');
    });
  });

  suite('_listDriveFolders()', () => {
    let element;
    setup(() => {
      element = fixture('Basic');
    });

    test('Clears driveFolders', () => {
      element.driveFolders = [];
      element._listDriveFolders();
      assert.isUndefined(element.driveFolders);
    });

    test('Calls _dispatchReadDriveSettings()', () => {
      const spy = sinon.spy(element, '_dispatchReadDriveSettings');
      element._listDriveFolders();
      assert.isTrue(spy.called);
    });

    test('Sets driveFolders property', () => {
      element.addEventListener('google-drive-list-app-folders', function f(e) {
        element.removeEventListener('google-drive-list-app-folders', f);
        e.preventDefault();
        e.detail.result = Promise.resolve([{
          name: 'My APIs',
          id: 'folder1'
        }, {
          name: 'Company\'s APIs',
          id: 'folder2'
        }, {
          name: 'Developing',
          id: 'folder3'
        }]);
      });
      return element._listDriveFolders()
      .then(() => {
        assert.typeOf(element.driveFolders, 'array');
        assert.lengthOf(element.driveFolders, 3);
      });
    });

    test('Skips driveFolders if missing', () => {
      element.addEventListener('google-drive-list-app-folders', function f(e) {
        element.removeEventListener('google-drive-list-app-folders', f);
        e.preventDefault();
        e.detail.result = Promise.resolve([]);
      });
      return element._listDriveFolders()
      .then(() => {
        assert.isUndefined(element.driveFolders);
      });
    });

    test('Ignores errors', () => {
      element.addEventListener('google-drive-list-app-folders', function f(e) {
        element.removeEventListener('google-drive-list-app-folders', f);
        e.preventDefault();
        e.detail.result = Promise.reject(new Error('test'));
      });
      return element._listDriveFolders()
      .then(() => {
        assert.isUndefined(element.driveFolders);
      });
    });
  });

  suite('_getDriveFolders()', () => {
    let element;
    setup(() => {
      element = fixture('Basic');
      element.driveFolders = [{
        name: 'My APIs',
        id: 'folder1'
      }, {
        name: 'Company\'s APIs',
        id: 'folder2'
      }, {
        name: 'Developing',
        id: 'folder3'
      }];
    });

    test('Returns empty array when no drive parents', () => {
      const result = element._getDriveFolders();
      assert.deepEqual(result, []);
    });

    test('Returns names array when no driveFolders', () => {
      element.driveFolders = undefined;
      element.providerOptions = {
        parents: ['f1', 'f2']
      };
      const result = element._getDriveFolders();
      assert.deepEqual(result, [{name: 'f1'}, {name: 'f2'}]);
    });

    test('Returns names and ids', () => {
      element.providerOptions = {
        parents: ['folder1', 'new', 'folder2']
      };
      const result = element._getDriveFolders();
      assert.deepEqual(result, [{name: 'My APIs', id: 'folder1'}, {name: 'new'},
        {name: 'Company\'s APIs', id: 'folder2'}]);
    });
  });

  suite('_stopEvent()', () => {
    test('Stops propagation', () => {
      const element = fixture('Basic');
      const e = {
        stopPropagation: () => {}
      };
      const spy = sinon.spy(e, 'stopPropagation');
      element._stopEvent(e);
      assert.isTrue(spy.called);
    });
  });
  </script>
</body>
</html>
